name: Integration Tests

on:
  pull_request:
    branches: [master]
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  integration-tests:
    name: Integration Tests (KinD)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'tests/integration/requirements.txt'

      - name: Install KinD
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/latest/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/kubectl

      - name: Install Python dependencies
        run: |
          cd tests/integration
          pip install -r requirements.txt

      - name: Run integration tests
        run: |
          cd tests/integration
          pytest -v --tb=short --durations=10

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== KinD Clusters ==="
          kind get clusters || true
          
          echo "=== Kubectl contexts ==="
          kubectl config get-contexts || true
          
          echo "=== Namespaces ==="
          kubectl get namespaces || true
          
          echo "=== All pods ==="
          kubectl get pods --all-namespaces || true
          
          echo "=== Watcher logs ==="
          for ns in $(kubectl get namespaces -o jsonpath='{.items[*].metadata.name}' | tr ' ' '\n' | grep '^test-'); do
            echo "--- Namespace: $ns ---"
            kubectl logs -n $ns deployment/k8s-watcher --tail=100 || true
          done

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            tests/integration/.pytest_cache/
            tests/integration/*.log

      - name: Cleanup
        if: always()
        run: |
          kind delete cluster --name k8s-watcher-test || true
